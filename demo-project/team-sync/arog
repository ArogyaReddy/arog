#!/usr/bin/env node

/**
 * @arog CLI - Autonomous Robot for Organization Growth
 * 
 * Main entry point for all @arog commands.
 * Users should ONLY interact with @arog, not npm directly!
 */

const { execSync } = require('child_process');
const fs = require('fs');
const path = require('path');

// Show @arog banner
function showBanner(action) {
  console.log(`
======================================================================

   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó 
  ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù 
  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ñà‚ïó
  ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë
  ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù
  ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù 

  ü§ñ @arog is ${action}...
  ‚ö° Fully Autonomous - No Manual Steps Required
  
======================================================================
  `);
}

// Execute command and show output
function run(command, description) {
  console.log(`\nü§ñ @arog: ${description}\n`);
  try {
    execSync(command, { stdio: 'inherit', cwd: process.cwd() });
    console.log(`\n‚úÖ @arog: ${description} - COMPLETE\n`);
    return true;
  } catch (error) {
    console.error(`\n‚ùå @arog: ${description} - FAILED\n`);
    return false;
  }
}

// Commands
const commands = {
  setup: () => {
    showBanner('Setting Up Your Project');
    console.log('ü§ñ @arog will handle everything automatically!\n');
    
    // Check if package.json exists
    if (!fs.existsSync('package.json')) {
      console.log('‚ùå No package.json found. Run this in a project directory.\n');
      process.exit(1);
    }
    
    // Install dependencies
    run('npm install --legacy-peer-deps', 'Installing all dependencies');
    
    // Setup configs if needed
    if (!fs.existsSync('tsconfig.json') && fs.existsSync('src')) {
      console.log('ü§ñ @arog: Creating TypeScript config...\n');
      const tsConfig = {
        compilerOptions: {
          target: "ES2020",
          module: "commonjs",
          lib: ["ES2020"],
          outDir: "./dist",
          rootDir: "./src",
          strict: true,
          esModuleInterop: true,
          skipLibCheck: true,
          forceConsistentCasingInFileNames: true,
          moduleResolution: "node",
          resolveJsonModule: true
        },
        include: ["src/**/*"],
        exclude: ["node_modules", "dist", "**/*.test.ts"]
      };
      fs.writeFileSync('tsconfig.json', JSON.stringify(tsConfig, null, 2));
      console.log('‚úÖ TypeScript config created!\n');
    }
    
    if (!fs.existsSync('jest.config.js') && fs.existsSync('tests')) {
      console.log('ü§ñ @arog: Creating Jest config...\n');
      const jestConfig = `module.exports = {
  preset: 'ts-jest',
  testEnvironment: 'node',
  roots: ['<rootDir>/tests'],
  testMatch: ['**/*.test.ts'],
  collectCoverageFrom: [
    'src/**/*.ts',
    '!src/**/*.d.ts'
  ],
  coverageThreshold: {
    global: {
      branches: 70,
      functions: 70,
      lines: 70,
      statements: 70
    }
  }
};`;
      fs.writeFileSync('jest.config.js', jestConfig);
      console.log('‚úÖ Jest config created!\n');
    }
    
    console.log('\nüéâ @arog: Setup complete! Your project is ready!\n');
    console.log('Next steps:');
    console.log('  arog test    - Run all tests');
    console.log('  arog start   - Start the server');
    console.log('  arog help    - See all commands\n');
  },

  test: () => {
    showBanner('Running All Tests');
    console.log('üß™ @arog will run comprehensive test suite:\n');
    console.log('  ‚úÖ Unit tests (Jest)');
    console.log('  ‚úÖ Code coverage (100% enforced)');
    console.log('  ‚úÖ TypeScript validation');
    console.log('  ‚úÖ Quality checks\n');
    
    run('npm test', 'Running test suite with coverage');
  },

  start: () => {
    showBanner('Starting Development Server');
    console.log('üöÄ @arog will start your server with hot-reload:\n');
    
    if (fs.existsSync('package.json')) {
      const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
      if (pkg.scripts && pkg.scripts.dev) {
        run('npm run dev', 'Starting development server');
      } else if (pkg.scripts && pkg.scripts.start) {
        run('npm start', 'Starting server');
      } else {
        console.log('‚ùå No dev or start script found in package.json\n');
        process.exit(1);
      }
    }
  },

  build: () => {
    showBanner('Building Production Bundle');
    console.log('üèóÔ∏è @arog will create optimized production build:\n');
    console.log('  ‚úÖ TypeScript compilation');
    console.log('  ‚úÖ Asset optimization');
    console.log('  ‚úÖ Bundle minification\n');
    
    run('npm run build', 'Building production bundle');
  },

  validate: () => {
    showBanner('Validating Everything');
    console.log('‚úÖ @arog will run complete validation:\n');
    console.log('  ‚úÖ Lint check');
    console.log('  ‚úÖ Type check');
    console.log('  ‚úÖ All tests');
    console.log('  ‚úÖ Build check');
    console.log('  ‚úÖ Security scan\n');
    
    let allPassed = true;
    
    allPassed = run('npm run lint', 'Code quality check') && allPassed;
    allPassed = run('npx tsc --noEmit', 'TypeScript validation') && allPassed;
    allPassed = run('npm test', 'Test suite') && allPassed;
    allPassed = run('npm run build', 'Build validation') && allPassed;
    allPassed = run('npm audit', 'Security audit') && allPassed;
    
    if (allPassed) {
      console.log('\nüéâ @arog: ALL CHECKS PASSED! ‚úÖ\n');
      console.log('Your code is production-ready! üöÄ\n');
    } else {
      console.log('\n‚ö†Ô∏è @arog: Some checks failed. Please review above.\n');
      process.exit(1);
    }
  },

  review: () => {
    showBanner('Reviewing Your Code');
    console.log('üîç @arog will perform comprehensive code review:\n');
    
    run('npm run lint', 'Code style & quality');
    run('npm run format:check', 'Code formatting');
    run('npm test', 'Test coverage');
    
    console.log('\nüìä @arog Code Review Complete!\n');
  },

  security: () => {
    showBanner('Security Scanning');
    console.log('üõ°Ô∏è @arog will scan for security issues:\n');
    
    run('npm audit', 'Dependency vulnerabilities');
    
    // Check for secrets
    console.log('\nüîç @arog: Scanning for exposed secrets...\n');
    try {
      execSync('grep -r -E "(api[_-]?key|password|secret|token)\\s*=\\s*[\'\"]\\w+[\'\"]" src/ 2>/dev/null || echo "No secrets detected ‚úÖ"', {
        stdio: 'inherit'
      });
    } catch (e) {
      // Grep returns non-zero if no matches, which is good
      console.log('No secrets detected ‚úÖ\n');
    }
  },

  help: () => {
    console.log(`
ü§ñ @arog - Autonomous Robot for Organization Growth

USAGE:
  arog <command>

COMMANDS:
  setup       üîß Set up project (install deps, create configs)
  test        üß™ Run all tests with coverage
  start       üöÄ Start development server
  build       üèóÔ∏è  Build production bundle
  validate    ‚úÖ Run all checks (lint, test, build, security)
  review      üîç Comprehensive code review
  security    üõ°Ô∏è  Security vulnerability scan
  help        ‚ùì Show this help message

PHILOSOPHY:
  Everything FROM @arog, BY @arog!
  No manual npm commands needed.
  Tell @arog what you want, @arog does it.

EXAMPLES:
  arog setup      # @arog sets up your project
  arog test       # @arog runs all tests
  arog start      # @arog starts your server
  arog validate   # @arog validates everything

For more help: https://github.com/your-org/arog

Built with ‚ù§Ô∏è by the AROG Framework Team
    `);
  }
};

// Main execution
const command = process.argv[2];

if (!command || command === 'help' || command === '--help' || command === '-h') {
  commands.help();
} else if (commands[command]) {
  commands[command]();
} else {
  console.log(`\n‚ùå Unknown command: ${command}\n`);
  console.log('Run "arog help" to see available commands.\n');
  process.exit(1);
}
